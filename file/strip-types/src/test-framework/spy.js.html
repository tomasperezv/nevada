<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">strip-types/src/test-framework/spy.js | Jobandtalent API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-styles.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a><a href="../js-unit-tests.html">Unit tests</a>
  <a data-ice="repoURL" href="https://github.com/jobandtalent/nevada" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/clone-object.js~CloneObject.html">CloneObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/cookie-storage.js~CookieStorage.html">CookieStorage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/environment.js~Environment.html">Environment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/module-naming.js~ModuleNaming.html">ModuleNaming</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ERBTemplating">ERBTemplating</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/component/base</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/component/base/base-controller-view.js~BaseControllerView.html">BaseControllerView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/component/base/base-controller.js~BaseController.html">BaseController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/component/base/event-actions.js~EventActions.html">EventActions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DocumentEvents">DocumentEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ElementEvents">ElementEvents</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/dom</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-$">$</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/test-framework</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/dom-util.js~DOMUtil.html">DOMUtil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/inject.js~Inject.html">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/mock.js~Mock.html">Mock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/modulejs.js~ModuleJS.html">ModuleJS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/proxy-spy-handler.js~ProxySpyHandler.html">ProxySpyHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/spy.js~Spy.html">Spy</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">src/test-framework/dom-mutation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/dom-mutation/factory.js~DOMMutationFactory.html">DOMMutationFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/dom-mutation/mutation-base.js~DOMMutationBase.html">DOMMutationBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/dom-mutation/mutation-events.js~DOMMutationEvents.html">DOMMutationEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/strip-types/src/test-framework/dom-mutation/mutation-observer.js~DOMMutationObserver.html">DOMMutationObserver</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">strip-types/src/test-framework/spy.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">
&apos;use strict&apos;;

import Inject from &apos;./inject&apos;;
import ProxyHandler from &apos;./proxy-spy-handler&apos;;
import ModuleJS from &apos;@lrsjng/modulejs&apos;;

/**
 * The following module defines a Spy object used to intercept
 * operations on object methods and properties.
 *
 * Example of usage:
 *   ```javascript
 *     import Spy from &apos;test-framework/spy&apos;;
 *     const objectToSpy = { method: function() {} };
 *     var spy = new Spy();
 *     const spied = spy.watch(objectToSpy);
 *     spied.method();
 *     assert(spied.count === 1);
 *     assert(spied.called === true);
 *   ```
 *
 * It adds a layer on top of the es6 `Proxy` object combined with Reflect API,
 * that way we can intercept method and property calls, both defined and undefined.
 *
 * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy
 * @module Spy
 */
class Spy {

  constructor() {
    const self = this;

    /**
     * @private
     */
    /* eslint-disable arrow-body-style */
    this._mockedObjectExtensions = name =&gt; {
      return {
        __restore__() {
          self._spiedObjectsSet.delete(self._originalObject);
          if (self._handler !== null &amp;&amp; !self._handler.__modulejs__) {
            Inject.attach(self._originalObject, name);
          } else {
            delete ModuleJS._private.definitions[name];
            ModuleJS.define(name, self._originalObject);
          }
          self._handler = null;
        }
      };
    };
    /* eslint-enable arrow-body-style */

    /**
     * @private
     */
    this._originalObject = {};

    /**
     * @private
     */
    this._handler = null;

    /**
     * @private
     */
    this._spiedObjectsSet = new WeakSet();
  }

  /**
   * @param {Object} instance
   * @param {String} method
   * @param {Function|undefined} stub
   * @method intercept
   * @public
   */
  intercept(instance, method, stub) {
    const original = instance[method];
    /* eslint-disable no-param-reassign */
    instance[method] = (...args) =&gt; {
      instance[method].counter++;
      instance[method].called = true;

      let callResult = null;
      if (typeof stub === &apos;function&apos;) {
        callResult = stub.apply(instance, args);
      } else {
        callResult = original.apply(instance, args);
      }

      return callResult;
    };

    instance[method].restore = function () {
      instance[method] = original;
    };

    instance[method].counter = 0;
    instance[method].called = false;
    instance[method].__spy__ = true;
    /* eslint-enable no-param-reassign */
  }

  /**
   * Checks if a method is being watched
   * @param {Object} instance
   * @param {String} method
   * @public
   */
  watched(instance, method) {
    return typeof instance[method].__spy__ !== &apos;undefined&apos;;
  }

  /**
   * Removes the spy layer on an object&apos;s method
   * @param {ProxyHandler} mock
   * @public
   */
  restore(mock) {
    if (typeof mock.__restore__ === &apos;function&apos;) {
      mock.__restore__();
    }
  }

  /**
   * Watch an object methods and properties via a proxy
   * @param {Object} instance
   * @returns {Proxy}
   * @public
   */
  watch(instance) {
    this._assertAndRegisterObjectOverride(instance);

    this._handler = new ProxyHandler(instance, Object.keys(this._mockedObjectExtensions()));
    return this._initializeProxy(this._handler.get(), Object.getPrototypeOf(instance));
  }

  /**
   * Initializes a proxy object
   * @param {ProxyHandler} handler
   * @param {Object} proto
   * @private
   */
  _initializeProxy(handler, proto) {
    let proxy;
    if (typeof Proxy.create !== &apos;undefined&apos;) {
      proxy = Proxy.create(handler, proto);
    } else {
      proxy = new Proxy(proto, handler);
    }
    return proxy;
  }

  /**
   * @throws Error
   * @param {Object} instance
   * @private
   */
  _assertAndRegisterObjectOverride(instance) {
    if (this._spiedObjectsSet.has(instance)) {
      throw new Error(&apos;Spy can\&apos;t attach to objects that are already being spied&apos;);
    }

    this._spiedObjectsSet.add(instance);
  }

  /**
   * @param {String} name
   * @returns {Object|null}
   * @public
   */
  get(name) {
    return this._handler !== null ? this._handler.getPropertyRegister(name) : null;
  }

  /**
   * Creates a proxy object
   * @param  {Object} object
   * @param  {String} id
   * @param {Boolean} useModuleJS
   * @returns {ProxyHandler}
   * @public
   */
  mock(object, id, useModuleJS = false) {
    /* eslint-disable no-param-reassign */
    this._originalObject = object;

    let name = this._processObjectName(object.constructor.name);
    if (typeof id !== &apos;undefined&apos;) {
      name = id;
    }

    var objectExtensions = this._mockedObjectExtensions(name);
    Object.keys(objectExtensions).forEach(key =&gt; {
      object[key] = objectExtensions[key];
    });

    const proxy = this.watch(object);
    if (useModuleJS) {
      if (typeof ModuleJS._private.definitions[name] !== &apos;undefined&apos;) {
        delete ModuleJS._private.definitions[name];
      }

      ModuleJS.define(name, () =&gt; proxy);
      if (this._handler !== null) {
        this._handler.__modulejs__ = true;
      }
    } else {
      Inject.attach(proxy, name);
    }

    /* eslint-enable no-param-reassign */
    return proxy;
  }

  /**
   * Converts the first character of a string to lowercase
   * @param {String} name
   * @returns {String}
   * @private
   */
  _processObjectName(name) {
    return `${ name[0].toLowerCase() }${ name.slice(1) }`;
  }
}

export default Spy;</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
